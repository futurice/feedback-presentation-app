<link rel="import" href="../../seed-element-master/elements/star-rating-element.html">
<script type="text/javascript" src="../../bower_components/underscore/underscore.js"></script>  

<polymer-element name="question-average-element" attributes="projects background filter">
  <template>
    <style>
      :host {
        position: relative;
        background-color: #6bc177;
        padding-top:64px;
        color: rgb(255, 255, 255);
        overflow: hidden;
        user-select: none;
      }
  
      .column {
        -webkit-transition: all 2s;
        transition: all 2s;
      }

      .spec {
        position: absolute;
        text-align: center;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

      #npa-item
      {
        color: #8bc34a;
        font-size:120px;
        text-align:right;
      }

      #npa_header
      {
        text-align: center;
      }

      #npa_number
      {
        text-align: center;
        font-size: 70px;
        margin-bottom: 20px;
      }

      #question
      {
        text-align:center;
        margin: 10px;
      }

      .avg-number
      {
        font-size: 30px;
        margin: 10px;
        text-align:center;
      }

    </style>
      <div id="root" horizontal justified layout relative fit>
          <template repeat="{{ avg, avgIndex in averages_by_topic }}">
            <div vertical end-justified layout flex style="height: 100%">
            <div id="{{avg.topic}}" class="column" flex justified vertical layout style="max-height:{{avg.topic === 'Overall' ? (avg.average / 10.0) * 100 + 10 : (avg.average / 5.0) * 100 + 10}}%; background-color: {{backgrounds[avgIndex]}}">
              <div  class="avg-number" flex start-justified vertical layout>{{avg.average > 0.0 ? avg.average : ''}}</div>
              <div flex id="question" end-justified vertical layout>{{avg.topic}}</div>
            </div>
           <div>
          </template>
      </div>

  </template>
  <script>
  Polymer('question-average-element', {
    backgrounds: ['#64ba6f', '#60b36b', '#5cab66', '#57a362', '#539c5d', '#4f9458', '#4f9458', '#46824e', '#427a49', '#3e7345'],
    projectsChanged: function(oldvalue, newvalue)
    {
        var THIS = this;
       var avg_arr = _.chain(newvalue)
            .reduce(function(memo, val){ return memo.concat({topic: 'Overall', answer: val.value.npa_score}).concat(val.value.questions); }, [])
            .groupBy(function(val){ return val.topic; })
            .map(function(value, key){
              var avg = _.reduce(value, function(memo, ans) {return {i : (memo.i + 1), avg: (memo.avg * memo.i + ans.answer)/(memo.i+1)} }, {i: 0, avg: 0.0});
              return {topic: key, average: avg.avg.toFixed(1)}; })
            .value();

        if(avg_arr.length > 0) {
        avg_arr.forEach(function(elem){
              if(THIS.averages_by_topic == null) THIS.averages_by_topic = [];
              var same_topic = _.find(THIS.averages_by_topic, function(avg){ return avg.topic === elem.topic; });
              if(same_topic != null)
                same_topic.average = elem.average; 
              else
                THIS.averages_by_topic.push(elem);
                });
        }
        else {
          this.averages_by_topic.forEach(function(elem){elem.average = 0;});
        }
        
        //one time bind topics
    },
    ready: function(){
    }
  });
  </script>
</polymer-element>
